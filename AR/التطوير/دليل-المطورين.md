# دليل المطورين 👩‍💻👨‍💻

## نظرة عامة
مرحباً بك في دليل المطورين الخاص بمنصة كرزون. هذا الدليل سيساعدك في بناء تكاملات مخصصة والاستفادة من إمكانيات API المتقدمة.

## معلومات أساسية

### معمارية النظام
```
العميل (Client) ←→ Karzoun API ←→ قواعد البيانات
                ↓
         منصات التواصل (WhatsApp, Facebook, etc.)
```

### متطلبات أساسية
- معرفة بـ REST APIs
- فهم لـ JSON و HTTP protocols
- خبرة في معالجة Webhooks
- معرفة أساسية بالتشفير (OAuth 2.0)

## المصادقة والترخيص

### إنشاء مفاتيح API

#### الخطوة 1: إنشاء تطبيق جديد
```bash
POST /api/v1/apps
Content-Type: application/json
Authorization: Bearer {your_access_token}

{
  "name": "تطبيق التجارة الإلكترونية",
  "description": "تكامل مع متجرنا الإلكتروني",
  "callback_url": "https://mystore.com/webhook",
  "scopes": ["messages:read", "messages:write", "contacts:read"]
}
```

#### الخطوة 2: الحصول على المفاتيح
```json
{
  "app_id": "app_1234567890",
  "client_id": "kz_live_abcd1234efgh5678",
  "client_secret": "kz_secret_xyz789abc123def456",
  "webhook_secret": "whsec_1234567890abcdef"
}
```

### OAuth 2.0 Authentication
```javascript
// الحصول على رمز التفويض
const authUrl = `https://api.karzoun.com/oauth/authorize?
  client_id=${clientId}&
  redirect_uri=${redirectUri}&
  response_type=code&
  scope=messages:read messages:write contacts:read&
  state=${randomState}`;

// استبدال الرمز بـ Access Token
const tokenResponse = await fetch('https://api.karzoun.com/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    grant_type: 'authorization_code',
    client_id: clientId,
    client_secret: clientSecret,
    code: authCode,
    redirect_uri: redirectUri
  })
});
```

## Karzoun API Reference

### Base URL
```
Production: https://api.karzoun.com/v1
Sandbox: https://api.sandbox.karzoun.com/v1
```

### Headers مطلوبة
```http
Authorization: Bearer {access_token}
Content-Type: application/json
X-API-Version: 2025-01-01
Accept-Language: ar-SA
```

## إدارة الرسائل

### إرسال رسالة
```javascript
POST /messages
{
  "to": "+966501234567",
  "channel": "whatsapp",
  "type": "text",
  "content": {
    "text": "مرحباً! كيف يمكنني مساعدتك؟"
  },
  "metadata": {
    "source": "website_chat",
    "user_id": "user_123"
  }
}
```

### إرسال رسالة تفاعلية
```javascript
POST /messages
{
  "to": "+966501234567",
  "channel": "whatsapp",
  "type": "interactive",
  "content": {
    "text": "اختر الخدمة المطلوبة:",
    "buttons": [
      {
        "id": "btn_support",
        "text": "الدعم التقني"
      },
      {
        "id": "btn_sales", 
        "text": "المبيعات"
      }
    ]
  }
}
```

### إرسال وسائط متعددة
```javascript
POST /messages
{
  "to": "+966501234567",
  "channel": "whatsapp", 
  "type": "media",
  "content": {
    "media_type": "image",
    "media_url": "https://example.com/image.jpg",
    "caption": "منتجنا الجديد متوفر الآن!"
  }
}
```

## إدارة جهات الاتصال

### إنشاء جهة اتصال جديدة
```javascript
POST /contacts
{
  "phone": "+966501234567",
  "name": "أحمد محمد",
  "email": "ahmed@example.com",
  "attributes": {
    "city": "الرياض",
    "age": 25,
    "interests": ["تقنية", "رياضة"]
  },
  "tags": ["عميل_جديد", "مهتم_بالمنتجات"]
}
```

### تحديث بيانات الاتصال
```javascript
PATCH /contacts/{contact_id}
{
  "attributes": {
    "last_purchase": "2025-01-15",
    "total_spent": 1500
  },
  "tags": ["عميل_مميز"]
}
```

### البحث في جهات الاتصال
```javascript
GET /contacts?search=أحمد&tag=عميل_جديد&city=الرياض&limit=50
```

## إدارة الحملات التسويقية

### إنشاء حملة جديدة
```javascript
POST /campaigns
{
  "name": "عروض الصيف 2025",
  "type": "marketing",
  "channels": ["whatsapp", "telegram"],
  "schedule": {
    "start_date": "2025-06-01T10:00:00Z",
    "end_date": "2025-06-30T23:59:59Z",
    "timezone": "Asia/Riyadh"
  },
  "audience": {
    "tags": ["عميل_نشط"],
    "exclude_tags": ["unsubscribed"],
    "filters": {
      "city": "الرياض",
      "last_activity": "30_days"
    }
  },
  "content": {
    "text": "🎉 عروض الصيف الحصرية! خصم 30% على جميع المنتجات",
    "buttons": [
      {
        "text": "تسوق الآن",
        "url": "https://store.example.com/summer-sale"
      }
    ]
  }
}
```

## الـ Webhooks

### إعداد Webhook
```javascript
POST /webhooks
{
  "url": "https://myapp.com/karzoun-webhook",
  "events": [
    "message.received",
    "message.delivered", 
    "contact.created",
    "campaign.completed"
  ],
  "secret": "your_webhook_secret"
}
```

### معالجة Webhook Events
```javascript
const crypto = require('crypto');

app.post('/karzoun-webhook', (req, res) => {
  const signature = req.headers['x-karzoun-signature'];
  const payload = JSON.stringify(req.body);
  
  // التحقق من صحة الـ Signature
  const expectedSignature = crypto
    .createHmac('sha256', process.env.WEBHOOK_SECRET)
    .update(payload)
    .digest('hex');
    
  if (signature !== `sha256=${expectedSignature}`) {
    return res.status(401).send('Unauthorized');
  }
  
  // معالجة الحدث
  const event = req.body;
  
  switch(event.type) {
    case 'message.received':
      handleIncomingMessage(event.data);
      break;
      
    case 'contact.created':
      syncContactToCRM(event.data);
      break;
      
    case 'campaign.completed':
      generateCampaignReport(event.data);
      break;
  }
  
  res.status(200).send('OK');
});
```

### أنواع الأحداث المدعومة
```javascript
// رسائل
"message.received"     // رسالة جديدة مستقبلة
"message.delivered"    // تم تسليم الرسالة
"message.read"         // تم قراءة الرسالة
"message.failed"       // فشل في إرسال الرسالة

// جهات الاتصال
"contact.created"      // جهة اتصال جديدة
"contact.updated"      // تحديث بيانات الاتصال
"contact.subscribed"   // اشتراك في القائمة
"contact.unsubscribed" // إلغاء اشتراك

// الحملات
"campaign.started"     // بدء الحملة
"campaign.completed"   // انتهاء الحملة
"campaign.paused"      // إيقاف الحملة مؤقتاً

// البوتات
"bot.conversation_started" // بدء محادثة جديدة
"bot.conversation_ended"   // انتهاء المحادثة
"bot.button_clicked"       // نقر على زر تفاعلي
```

## تكاملات مخصصة

### تكامل مع CRM
```javascript
// مزامنة بيانات العملاء
async function syncCustomerData() {
  const contacts = await karzounAPI.getContacts({
    updated_since: lastSyncTime,
    limit: 1000
  });
  
  for (const contact of contacts) {
    await crmSystem.createOrUpdateContact({
      id: contact.phone,
      name: contact.name,
      email: contact.email,
      source: 'karzoun',
      customFields: contact.attributes
    });
  }
}
```

### تكامل مع نظام المبيعات
```javascript
// إرسال فاتورة تلقائياً
async function sendInvoiceNotification(orderId) {
  const order = await salesSystem.getOrder(orderId);
  
  await karzounAPI.sendMessage({
    to: order.customerPhone,
    channel: 'whatsapp',
    type: 'template',
    template: {
      name: 'invoice_notification',
      language: 'ar',
      parameters: [
        order.customerName,
        order.total,
        order.invoiceUrl
      ]
    }
  });
}
```

## معالجة الأخطاء

### رموز الأخطاء الشائعة
```javascript
// 400 Bad Request
{
  "error": "validation_error",
  "message": "رقم الهاتف غير صحيح",
  "details": {
    "field": "phone",
    "code": "invalid_format"
  }
}

// 401 Unauthorized  
{
  "error": "authentication_failed",
  "message": "رمز التفويض غير صحيح أو منتهي الصلاحية"
}

// 429 Rate Limit Exceeded
{
  "error": "rate_limit_exceeded", 
  "message": "تم تجاوز الحد المسموح للطلبات",
  "retry_after": 60
}

// 500 Internal Server Error
{
  "error": "internal_error",
  "message": "خطأ داخلي في الخادم",
  "reference": "err_1234567890"
}
```

### إعادة المحاولة
```javascript
async function apiCallWithRetry(apiCall, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await apiCall();
    } catch (error) {
      if (error.status === 429) {
        // معالجة Rate Limiting
        const retryAfter = error.headers['retry-after'] || 60;
        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        continue;
      }
      
      if (error.status >= 500 && i < maxRetries - 1) {
        // إعادة المحاولة للأخطاء الخادمية
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
        continue;
      }
      
      throw error;
    }
  }
}
```

## أدوات التطوير

### Postman Collection
حمل مجموعة Postman الكاملة:
```
https://api.karzoun.com/postman/collection.json
```

### SDK للغات المختلفة

#### JavaScript/Node.js
```bash
npm install karzoun-sdk
```

```javascript
const Karzoun = require('karzoun-sdk');

const client = new Karzoun({
  apiKey: 'your_api_key',
  environment: 'production' // أو 'sandbox'
});

// إرسال رسالة
await client.messages.send({
  to: '+966501234567',
  text: 'مرحباً من كرزون!'
});
```

#### Python
```bash
pip install karzoun-python
```

```python
import karzoun

client = karzoun.Client(api_key='your_api_key')

# إرسال رسالة
client.messages.send(
    to='+966501234567',
    text='مرحباً من كرزون!'
)
```

### أدوات الاختبار
```javascript
// اختبار الـ Webhook محلياً
const ngrok = require('ngrok');

const url = await ngrok.connect(3000);
console.log(`Webhook URL: ${url}/webhook`);

// استخدم هذا الرابط في إعدادات Webhook
```

## أمثلة شاملة

### بناء شات بوت للتجارة الإلكترونية
```javascript
// معالج الرسائل الواردة
app.post('/webhook', (req, res) => {
  const message = req.body.data;
  
  if (message.type === 'text') {
    const text = message.content.text.toLowerCase();
    
    if (text.includes('منتج') || text.includes('سعر')) {
      sendProductCatalog(message.from);
    } else if (text.includes('طلب') || text.includes('شراء')) {
      startOrderProcess(message.from);
    } else if (text.includes('حالة الطلب')) {
      checkOrderStatus(message.from);
    } else {
      sendDefaultResponse(message.from);
    }
  }
  
  res.status(200).send('OK');
});

async function sendProductCatalog(phoneNumber) {
  const products = await getTopProducts();
  
  await karzounAPI.sendMessage({
    to: phoneNumber,
    channel: 'whatsapp',
    type: 'interactive',
    content: {
      text: 'اختر من منتجاتنا المميزة:',
      type: 'list',
      list: {
        sections: [{
          title: 'المنتجات',
          rows: products.map(product => ({
            id: `product_${product.id}`,
            title: product.name,
            description: `${product.price} ريال`
          }))
        }]
      }
    }
  });
}
```

---

## الدعم والمساعدة

### للمطورين
- 📧 البريد: developers@karzoun.com
- 💬 مجتمع Discord: [انضم هنا](https://discord.gg/karzoun)
- 📚 الوثائق التفاعلية: [docs.karzoun.com](https://docs.karzoun.com)
- 🐛 الإبلاغ عن الأخطاء: [github.com/karzoun/issues](https://github.com/karzoun/issues)

### موارد إضافية
- [أمثلة الكود على GitHub](https://github.com/karzoun/examples)
- [فيديوهات تعليمية للمطورين](https://youtube.com/karzoun-dev)
- [بودكاست التطوير العربي](https://podcast.karzoun.com)

*آخر تحديث: يناير 2025*
